# 웹 요청에서 데이터의 흐름 - OSI 7 Layer 관점

사용자가 웹 브라우저에서 https://example.com 에 접속하는 상황에서 OSI 7 Layer는 각각 어떤 역할을 수행하는 지 알아보자.

## 응용 계층(Application Layer)

우선 사용자가 웹 브라우저에 https://example.com 을 입력한다. 웹 브라우저는 이를 보고 `HTTP GET /` 요청을 생성하고 DNS(Domain Name System)에 example.com에 대한 IP 주소가 존재하는 지 확인하고, example.com 에 대한 IP 주소가 존재한다면 IP 주소를 응답으로 획득한다.

DNS(Domain Name System)으로부터 IP 주소를 획득하는 원리는 간단하게 설명하면 다음과 같다.

1. 내 컴퓨터의 hosts 파일을 조회하여 해당 도메인에 대해서 매핑되는 IP 주소가 있는지 확인한다. 만약 매핑되는 도메인이 있다면 바로 사용한다.
2. 브라우저 또는 OS 캐시를 확인한다. 만약 브라우저 캐시 또는 OS 캐시에 존재한다면 바로 사용한다.
3. ISP(인터넷 서비스 제공업체로 우리나라에서는 KT, SK브로드밴드, LGU+ 등이 존재)또는 회사 내부 로컬 DNS 서버로 요청한다. 만약 ISP 또는 회사 내부 로컬 DNS 서버의 캐시에 매핑되는 도메인이 있다면 바로 사용한다.
4. ISP 또는 로컬 DNS 서버는 루트 네임서버(Root Name Server)에 요청을 보낸다. 루트 네임서버는 도메인의 최상위 계층(.com, .org 등)에 대한 정보를 알려주는 서버이다. 내 요청은 example.com 이므로 루트 네임서버는 .com 을 담당하는 TLD 네임서버의 주소를 반환해준다.
5. 루트 네임서버가 알려준 TLD 네임서버에 요청을 보내서 example.com 의 권한 네임서버(Authoritative Name Server) 주소를 받는다. TLD(Top Level Domain) 네임서버는 .com, .net, .org 등의 도메인을 관리하는 서버로 .com TLD 네임서버는 example.com 과 같은 도메인을 관리한다. 하지만 해당 도메인에 매핑되는 IP 주소는 권한 네임서버가 가지고 있다.
6. TLD 네임서버가 알려준 권한 네임서버에 요청을 보낸다. 권한 네임서버는 example.com에 대한 IP주소를 클라이언트에게 반환하게 된다.

이렇게 example.com에 대한 IP주소를 획득하고, HTTPS에 대한 SSL/TLS 핸드셰이크를 수행한다. SSL/TLS 핸드셰이크는 스킵하도록 하겠다.

응용계층에서 작업이 완료된 데이터는 캡슐화 되어 표현계층으로 넘어가게 된다.
## 표현 계층(Presentation Layer)

HTTPS 프로토콜이므로 캡슐화하여 넘어온 데이터에 대해서 암호화가 이루어지고, 데이터 압축이 필요한 경우 gzip 등의 인코딩을 적용한다. 또한 웹 브라우저가 요청 헤더와 데이터를 JSON, XML 등으로 변환하게 된다. 데이터가 이미지인 경우 JPEG, GIF 등이 될 수 있다.

이렇게 암호화, 인코딩, 변환된 데이터에 대해서 캡슐화 하여 세션계층으로 넘어가게 된다.
## 세션 계층(Session Layer)

HTTPS 프로토콜이므로 SSL/TLS 핸드셰이크 과정에서 세션 키를 생성한다. 또한 웹 서버와의 지속적인 연결을 유지하기 위해서 세션 쿠기나 JWT를 사용할 수도 있다.

이렇게 세션과 관련된 작업을 끝내고 데이터를 캡슐화하여 전송계층으로 넘어가게 된다.
## 전송 계층(Transport Layer)

HTTPS 프로토콜이므로 전송계층에서는 TCP 3-way handshake를 수행하여 서버와의 연결을 확립한다. 또한 데이터를 TCP 세그먼트로 나누고 포트 번호를 부여한다. HTTPS 이므로 443 포트번호를 부여하게된다. 데이터 전송 중 오류가 발생한다면 TCP 프로토콜이므로 재전송 메커니즘이 동작한다.

이렇게 TCP 프로토콜로 인하여 신뢰성, 연결성 등을 데이터에 대해서 확립하고, 목적지 포트번호를 붙여서 캡슐화하여 네트워크계층으로 넘어가게 된다.
## 네트워크 계층(Network Layer)

브라우저는 DNS로부터 획득한 IP주소를 사용하여 패킷을 생성하게 된다. 패킷에 출발지 IP, 목적지 IP를 붙여서 생성하게 된다. 이렇게 생성된 패킷은 라우터를 통해서 가장 적합한 알고리즘을 통해서 목적지까지 패킷이 전송된다.

라우터는 네트워크 계층에서 사용되는 네트워크 장비이며, 서로 다른 네트워크 사이에서 패킷을 가장 적합한 경로로 보내주는 역할을 수행한다. 예를들어 10.10.11.1/24 의 출발지에서 10.10.10.1/24 의 목적지로 패킷을 보내고자 할 때 적합한 경로로 패킷을 보내주는 역할을 하는 것이다. 출발지 네트워크 주소는 10.10.11.0 이고 목적지 네트워크 주소는 10.10.10.0 이므로 서로 다른 네트워크이므로 3계층 장비가 경로를 라우팅 해주는 것이다.

이렇게 목적지 네트워크까지 패킷을 전달했다면, 이를 캡슐화하여 데이터 링크 계층으로 보내게 된다.
## 데이터 링크 계층(Data Link Layer)

라우터가 목적지 네트워크까지 패킷을 성공적으로 전달했다면, 데이터 링크 계층에서는 스위치와 같은 2계층 장비가 동일한 네트워크에서 목적지 IP주소에 대한 MAC 주소를 찾는 역할을 수행한다.

스위치는 ARP를 통해서 목적지 IP주소에 매핑되는 MAC주소를 찾는 역할을 수행한다. ARP는 Address Resolution Protocol의 약자로 주소변환프로토콜이라고 불린다. 스위치는 목적지 IP주소에 대한 MAC주소를 찾기 위해서 자기 자신을 제외한 모든 포트로 목적지 IP주소와 일치하는 기기가 어딨는지 브로드캐스팅을 수행한다. 일치하지 않는 기기들은 해당 프레임을 버리고, 일치하는 기기만이 자신의 MAC주소와 함께 응답을 하게된다. 이렇게 스위치는 목적지 IP주소와 매핑되는 MAC주소를 찾게되고, 자신의 ARP 캐시 테이블에 저장하여 추후에는 ARP 요청을 보내지 않고도 찾을 수 있게된다.

이렇게 찾은 MAC주소와 함께 데이터를 캡슐화하여 물리계층으로 보내게 된다.
## 물리 계층(Physical Layer)

찾은 목적지 MAC 주소를 기반으로 데이터를 0과 1의 비트 형태로 변환하여 물리 매체(광섬유, 케이블 등)를 통해 데이터를 전송하게 된다.